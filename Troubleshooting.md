# Домашнее задание к занятию 6. «Troubleshooting»

## Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD-операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести эту операцию:

- напишите список операций, которые вы будете производить для остановки запроса пользователя;
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.

### Ответ:

- для начала необходимо найти запросы выполняющиеся более 3 минут командой db.currentOp({"secs_running":{$gte: 180}}) (должен быть включен профилировщик с уровнем 1 или 2)  
визуально находим запрос пользователя  
останавливаем запрос командой db.killOp(opid)  
- во первых необходимо включит и настроить профилирование базы данных db.setProfilingLevel() (задать 1 уровень и настроить фильтр или установить 2 уровень)
далее необходимо выявить причину долго запроса, для этого необходимо построить статистику, описывающую завершенное выполнение запроса explain(‘executionStats’) 
в случае выборки по большому количеству записей необходимо построить индекс.


## Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причём отношение количества записанных key-value-значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:

- сначала происходит рост отношения записанных значений к истекшим,
- Redis блокирует операции записи.

Как вы думаете, в чём может быть проблема?

### Ответ:

Как сказанно в официальной документации:
"Redis удаляет ключи с истекшим сроком действия двумя способами:
ленивый способ истекает сроком действия ключа, когда он запрашивается командой, но оказывается, что срок его действия уже истек.
активный путь истекает через несколько ключей каждые 100 миллисекунд.   
Учитывая, что ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP по умолчанию установлено значение 20, а процесс выполняется десять раз в секунду, обычно активно истекает только 200 ключей в секунду, если в базе данных есть много-много ключей, срок действия которых истекает в одну и ту же секунду, и они составляют не менее 25% текущей совокупности ключей с установленным сроком действия, Redis может заблокировать, чтобы получить процент ключей, срок действия которых уже истек ниже 25%."

Вероятно всего в этом и есть причина - сначала происходит прирост, Redis это видит и блокирует записи.

## Задача 3

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей в таблицах базы
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения этой проблемы вы можете предложить?

### Ответ:

Судя по документации данная ошибка имеет большое количество причин. Но в нашем случае мы наблюдаем закономерность (рост записей - ошибка). В дофициальной документации сказанно: " Если mysqld получает пакет, который слишком велик или не соответствует порядку, он предполагает, что что-то пошло не так с клиентом, и закрывает соединение."   
И также нам предлагается решение: " Если вам нужны большие запросы (например, если вы работаете с большими BLOBстолбцами), вы можете увеличить лимит запросов, установив переменную сервера max_allowed_packet , которая по умолчанию имеет значение 64 МБ. Вам также может потребоваться увеличить максимальный размер пакета на стороне клиента".


## Задача 4

Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объёмом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

Как бы вы решили эту проблему?

### Ответ:

В данном случае начала заканчиваться память и сервер вызвал Out-Of-Memory Killer - процесс, который завершает приложение, чтобы спасти ядро от сбоя. Один из способов это увеличить раздел подкачки. 

---

